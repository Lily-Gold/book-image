<div class="bg-[#F4F4F4] pt-[1.5rem] pb-6 min-h-[87vh]">

  <h2 class="text-3xl font-bold text-center text-[#004865] mb-8">
    マイページ
  </h2>

  <div class="max-w-5xl mx-auto px-1">

    <!-- プロフィールカード -->
    <div class="bg-white rounded-xl shadow-md p-2 pl-6 flex items-center gap-6 mb-14 relative">

      <div class="shrink-0 ml-5">
        <% if current_user.avatar.attached? %>
          <%= image_tag display_image_url(current_user, size: :avatar_120, image_attribute: :avatar),
                class: "w-[120px] h-[120px] rounded-full object-cover scale-90 border border-gray-400/60" %>
        <% else %>
          <%= image_tag "avatar.png",
                class: "w-[120px] h-[120px] rounded-full object-cover scale-175" %>
        <% end %>
      </div>

      <div class="flex-1 mt-[-2px] pl-6">
        <p class="text-xl font-semibold text-[#004865]"><%= current_user.name %></p>
        <p class="text-sm text-gray-600 mt-1"><%= current_user.email %></p>

        <div class="text-sm text-gray-700 mt-4 leading-relaxed max-w-[700px]">
          <%= simple_format(current_user.introduction, {}, wrapper_tag: "div") %>
        </div>

        <div class="flex items-center gap-3 mt-4 -mt-18 text-sm text-gray-700">
          <span>登録日：<%= current_user.created_at.strftime('%Y/%m/%d') %></span>

          <!-- ▼ X シェアボタン（アプリ紹介） -->
          <%= link_to(
                "https://twitter.com/intent/tweet?text=#{ERB::Util.url_encode(share_app_text)}&url=#{ERB::Util.url_encode(root_url)}",
                target: "_blank",
                rel: "noopener noreferrer",
                class: "inline-flex items-center justify-center
                        w-8 h-8
                        bg-black rounded-md
                        hover:opacity-80 transition"
              ) do %>

            <!-- X ロゴ（黒背景＋白） -->
            <svg xmlns="http://www.w3.org/2000/svg"
                 fill="currentColor"
                 viewBox="0 0 24 24"
                 class="w-4 h-4 text-white">
              <path d="M18.244 2H21.5l-7.42 8.495L23 22h-6.828l-5.364-7.044L4.896 22H1.64l7.93-9.073L2 2h6.91l4.713 6.231L18.244 2Zm-2.42 18h1.884L7.24 4H5.27l10.554 16Z"/>
            </svg>

          <% end %>
        </div>

        <%= link_to edit_user_registration_path,
              class: "absolute bottom-4 right-5
                      flex items-center gap-1.5
                      text-sm text-gray-500
                      hover:text-[#986321]
                      hover:underline
                      underline-offset-4
                      transition" do %>
          アカウント設定
        <% end %>
      </div>
    </div>


    <!-- ▼▼ タブ切り替えエリア ▼▼ -->
    <div data-controller="profile-tabs">

      <!-- ★ 全幅タブバー -->
      <div class="flex mb-10 border border-[#CDD5DF] bg-white rounded-lg overflow-hidden w-full shadow-[0_1px_3px_rgba(0,0,0,0.06)]">

        <!-- 投稿したレビュー -->
        <button
          data-profile-tabs-target="tab"
          data-index="0"
          data-action="click->profile-tabs#switch"
          class="flex-1 px-4 py-2 text-center cursor-pointer
                 bg-[#004865] text-white text-sm font-medium">
          投稿したレビュー（<%= @reviews.count %>）
        </button>

        <div class="w-px bg-[#CDD5DF]"></div>

        <!-- ブックマーク -->
        <button
          data-profile-tabs-target="tab"
          data-index="1"
          data-action="click->profile-tabs#switch"
          class="flex-1 px-4 py-2 text-center cursor-pointer
                 bg-white text-gray-600 text-sm font-normal">
          ブックマーク
        </button>

        <div class="w-px bg-[#CDD5DF]"></div>

        <!-- 印象カラー傾向 -->
        <button
          data-profile-tabs-target="tab"
          data-index="2"
          data-action="click->profile-tabs#switch"
          class="flex-1 px-4 py-2 text-center cursor-pointer
                 bg-white text-gray-600 text-sm font-normal">
          印象カラー傾向
        </button>
      </div>


      <!-- ▼ パネル：投稿したレビュー -->
      <div data-profile-tabs-target="panel">
        <% if @reviews.empty? %>
          <div class="text-center py-16 text-gray-500 leading-relaxed">
            まだレビューがありません。<br>
            あなたの最初の“本の色”を投稿してみませんか？

            <div class="mt-6">
              <%= link_to "最初のレビューを投稿する", new_review_path,
                  class: "inline-block px-4 py-2 bg-[#986321] text-white rounded-lg text-sm hover:opacity-90 transition cursor-pointer" %>
            </div>
          </div>
        <% else %>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
            <% @reviews.each do |review| %>
            <%= render "reviews/review_card_small",
                       review: review,
                       panel_id: "my_reviews" %>
          <% end %>
        </div>
      <% end %>
      </div>

      <!-- ▼ パネル：ブックマーク -->
      <div class="hidden" data-profile-tabs-target="panel">
        <%= render "profiles/bookmarked_reviews" %>
      </div>

      <!-- ▼ パネル:印象カラー傾向 -->
      <div class="hidden text-gray-700 pl-7" data-profile-tabs-target="panel">

        <% if @color_stats.present? %>
          <% top_colors = @color_stats.first(3) %>
          <% total_count = @color_stats.sum { |s| s[:count] } %>

          <div
            data-controller="chart"
            data-chart-labels-value="<%= @color_stats.map { |s| s[:name] }.to_json %>"
            data-chart-counts-value="<%= @color_stats.map { |s| s[:count] }.to_json %>"
            data-chart-colors-value="<%= @color_stats.map { |s| s[:color] }.to_json %>"
          >

            <!-- 横並びレイアウト -->
            <div class="max-w-4xl mx-auto py-6 pl-20 flex flex-col md:flex-row gap-10 items-center">

              <!-- グラフ＋総数 -->
              <div class="flex flex-col items-center shrink-0 -mt-3">

                <!-- 総数 -->
                <p class="mb-6 text-2xl font-bold text-[#004865]">
                  総合レビュー数：<%= total_count %>件
                </p>

                <!-- グラフ -->
                <div class="w-[275px] h-[275px] mb-2">
                  <canvas data-chart-target="canvas"></canvas>
                </div>

              </div>

              <!-- 右側：分析結果 -->
              <div class="w-full max-w-sm space-y-4 pl-20 -mt-8">

                <!-- TOP3 -->
                <div>
                  <p class="text-lg font-medium text-[#004865] mb-2">
                    あなたが選ぶ印象カラー
                  </p>

                  <ul class="space-y-3 text-lg">
                    <% 3.times do |index| %>
                      <% color = top_colors[index] %>

                      <li class="flex items-center gap-3">
                        <span class="text-base font-medium text-[#004865] w-5">
                          <%= "#{index + 1}." %>
                        </span>

                        <% if color.present? %>
                          <span
                            class="w-4 h-4 rounded-full"
                            style="background-color: <%= color[:color] %>">
                          </span>

                          <span class="flex-1">
                            <%= color[:name] %>
                          </span>

                          <span class="text-sm text-gray-500">
                            <%= color[:count] %>件
                          </span>
                        <% else %>
                          <span class="w-4 h-4"></span>
                          <span class="flex-1">
                            ―
                          </span>
                          <span class="text-sm text-gray-500">
                            0件
                          </span>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                </div>

              </div>
            </div>
          </div>

        <% else %>
          <div class="text-center py-16 text-gray-500 leading-relaxed">
            まだ分析できる投稿がありません。<br>
            レビューを投稿すると、印象カラーの傾向を確認できます。
            <div class="mt-6">
              <%= link_to "最初のレビューを投稿する",
                new_review_path,
                class: "inline-block px-4 py-2 bg-[#986321] text-white rounded-lg text-sm hover:opacity-90 transition" %>
            </div>
          </div>
        <% end %>

      </div>
    </div>
  </div>
</div>
