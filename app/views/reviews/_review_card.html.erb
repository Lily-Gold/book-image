<% tag_color = review.image_tag&.color || "#cccccc" %>
<% text_color = text_color_for(tag_color) %>

<% avatar_url = display_image_url(review.user, size: :avatar_40, image_attribute: :avatar) %>
<% avatar_missing = avatar_url.blank? %>

<div class="flex bg-white rounded-xl shadow-md overflow-hidden mb-8"
     style="transform: scale(0.92); transform-origin: top center;">
  
  <!-- 左：書影 -->
  <div class="w-1/3 p-4 flex flex-col items-center"
       style="background-color: <%= tag_color %>;">
    
    <% cover_url =
         if review.book.cover.attached?
           url_for(review.book.cover)
         elsif review.book.cover_url.present?
           review.book.cover_url
         end
    %>

    <% if cover_url.present? %>
      <%= image_tag cover_url,
            class: "shadow-md mb-3 w-[120px] h-[170px] object-cover" %>
    <% else %>
      <%= image_tag "no_cover.png",
            class: "shadow-md mb-3 w-[120px] h-[170px] object-cover" %>
    <% end %>

    <% if review.image_tag.present? %>
      <span class="text-xs font-medium px-3 py-1 rounded-full shadow-sm self-start"
        style="
          background-color:<%= tag_color %>;
          color:<%= text_color %>;
          border: 2px solid <%= text_color %>;
        ">
        <%= review.image_tag.name %>
      </span>
    <% end %>
  </div>

  <!-- 右：内容 -->
  <div class="w-2/3 px-5 pt-2 pb-5 flex flex-col relative
              <%= avatar_missing ? 'top-[-6px]' : 'top-[4px]' %>">

    <div class="flex flex-col gap-2.5">

      <div class="flex justify-between items-center -ml-0.5">
        <div class="flex items-center gap-2 <%= avatar_missing ? '-translate-x-3.5' : '' %>">

          <% avatar_url = display_image_url(review.user, size: :avatar_40, image_attribute: :avatar) %>

          <% if avatar_url.present? %>
            <%= image_tag avatar_url,
                  class: "w-8 h-8 rounded-full object-cover border border-gray-400/60" %>
          <% else %>
            <%= image_tag "avatar.png",
                  class: "w-14 h-14 rounded-full object-cover" %>
          <% end %>

          <p class="text-base font-medium text-gray-700 <%= avatar_missing ? '-translate-x-2' : '' %>">
            <%= review.user.name %>
          </p>
        </div>

        <p class="text-sm text-gray-500 whitespace-nowrap">
          <%= review.created_at.strftime("%Y/%m/%d") %>
        </p>
      </div>

      <div class="<%= avatar_missing ? '-mt-2.5' : 'mt-1' %>">
        <p class="text-lg font-semibold overflow-hidden text-ellipsis whitespace-nowrap">
          <%= review.book.title %>
        </p>

        <p class="text-sm text-gray-500 overflow-hidden text-ellipsis whitespace-nowrap">
          <%= review.book.author.presence || "未設定" %>
        </p>
      </div>

      <p class="text-sm text-gray-700 mt-0.5">
        <% preview = truncate_for_two_lines(review.content) %>

        <% if review.is_spoiler %>
          <span class="text-red-500 font-semibold">[ネタバレ]</span>
          <span
            data-controller="spoiler"
            data-spoiler-target="content"
            data-action="click->spoiler#toggle"
            class="opacity-10 hover:opacity-100 transition-opacity duration-200 cursor-pointer"
          >
            <%= preview %>
          </span>
        <% else %>
          <%= preview %>
        <% end %>
      </p>

    </div>

    <div class="flex items-center justify-between mt-auto">
      <!-- 左：いいね＋ブックマーク -->
      <div class="flex items-center gap-3 text-[#986321]">
        <%= render "likes/button", review: review %>
        <%= render "bookmarks/button", review: review %>
        <%= render "comments/button", review: review %>
      </div>

      <!-- 右：詳細 -->
      <%= link_to "詳細を見る", review_path(review),
            class: "px-4 py-2 bg-[#986321] text-white text-sm rounded-lg hover:opacity-90 transition" %>
    </div>

  </div>
</div>
