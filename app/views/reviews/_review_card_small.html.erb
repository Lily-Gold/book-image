<% panel_id ||= "default" %>
<% tag_color = review.image_tag&.color || "#cccccc" %>
<% text_color = text_color_for(tag_color) %>

<% avatar_url = display_image_url(review.user, size: :avatar_26, image_attribute: :avatar) %>
<% avatar_missing = avatar_url.blank? %>

<div id="review-card-<%= panel_id %>-<%= review.public_id %>"
     class="flex bg-white rounded-xl shadow-md overflow-hidden mb-4 scale-[0.925] origin-top">
  
  <!-- 左：書影 -->
  <div class="w-1/3 p-3 flex flex-col items-center"
       style="background-color: <%= tag_color %>;">
    
    <% cover_url =
         if review.book.cover.attached?
           url_for(review.book.cover)
         elsif review.book.cover_url.present?
           review.book.cover_url
         end
    %>

    <% if cover_url.present? %>
      <%= image_tag cover_url,
            class: "shadow-md mb-2 w-full aspect-[120/170] object-cover rounded" %>
    <% else %>
      <%= image_tag "no_cover.png",
            class: "shadow-md mb-2 w-full aspect-[120/170] object-cover rounded" %>
    <% end %>

    <% if review.image_tag.present? %>
      <span class="text-[10px] font-medium px-2 py-0.5 rounded-full shadow-sm self-start"
        style="
          background-color:<%= tag_color %>;
          color:<%= text_color %>;
          border: 1px solid <%= text_color %>;
        ">
        <%= review.image_tag.name %>
      </span>
    <% end %>
  </div>

  <!-- 右：内容 -->
  <div class="w-2/3 px-4 pt-3 pb-4 flex flex-col text-xs <%= avatar_missing ? '-mt-2' : '' %>">

    <div class="flex justify-between items-center mb-1">
      <div class="flex items-center gap-1 ml-[-2px] <%= avatar_missing ? '-translate-x-[9px]' : '' %>">

        <% avatar_url = display_image_url(review.user, size: :avatar_26, image_attribute: :avatar) %>

        <% if avatar_url.present? %>
          <%= image_tag avatar_url,
                class: "w-[26px] h-[26px] rounded-full object-cover border border-gray-400/60 scale-[0.90]" %>
        <% else %>
          <%= image_tag "avatar.png",
              class: "w-[43px] h-[43px] rounded-full object-cover" %>
        <% end %>

        <p class="text-[12px] font-medium text-gray-700 <%= avatar_missing ? '-translate-x-[8px]' : '' %>">
          <%= review.user.name %>
        </p>
      </div>

      <p class="text-[10px] text-gray-500 whitespace-nowrap">
        <%= review.created_at.strftime("%Y/%m/%d") %>
      </p>
    </div>

    <!-- タイトル〜本文（ここだけ動かす） -->
    <div class="<%= avatar_missing ? '-mt-2.5 pt-[1px]'  : '-mt-0' %>">
      <p class="text-sm font-semibold truncate"><%= review.book.title %></p>

      <p class="text-[11px] text-gray-500 truncate">
        <%= review.book.author.presence || "未設定" %>
      </p>

      <p class="text-[11px] text-gray-700 mt-3 line-clamp-2">
        <% preview = truncate_for_two_lines(review.content) %>
        <% if review.is_spoiler %>
          <span class="text-red-500 font-semibold">[ネタバレ]</span>
          <span
            class="
              opacity-10
              hover:opacity-100
              active:opacity-100
              transition-opacity
              duration-200
            "
          >
            <%= preview %>
          </span>
        <% else %>
          <%= preview %>
        <% end %>
      </p>
    </div>

    <div class="flex items-center justify-between mt-auto">

      <div class="flex items-center gap-1 text-[#986321]">

        <div id="like-button-<%= panel_id %>-<%= review.public_id %>">
          <%= render "likes/button",
                review: review,
                panel_id: panel_id %>
        </div>

        <div id="bookmark-button-<%= panel_id %>-<%= review.public_id %>">
          <%= render "bookmarks/button",
                review: review,
                panel_id: panel_id %>
        </div>

        <%= render "comments/button", review: review %>

      </div>

      <%= link_to "詳細", review_path(review),
            class: "px-3 py-1.5 bg-[#986321] text-white text-[11px] rounded hover:opacity-90 transition" %>
    </div>

  </div>
</div>
