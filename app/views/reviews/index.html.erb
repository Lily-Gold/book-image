<div class="bg-[#F4F4F4] pt-[1.5rem] min-h-[87vh]">

  <h2 class="text-3xl font-bold text-center text-[#004865] mb-8">
    投稿一覧
    <span class="text-lg text-[#004865] font-semibold">( <%= @reviews.count %> 件 )</span>
  </h2>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 px-7">

    <% @reviews.each do |review| %>
      <% tag_color = review.image_tag&.color || "#cccccc" %>
      <% text_color = text_color_for(tag_color) %>

      <div class="flex bg-white rounded-xl shadow-md overflow-hidden mb-8"
           style="transform: scale(0.92); transform-origin: top center;">

        <!-- 左：書影 -->
        <div class="w-1/3 p-4 flex flex-col items-center"
             style="background-color: <%= tag_color %>;">
          
          <% if review.book.cover.attached? %>
            <%= image_tag review.book.cover.variant(resize_to_fill: [120, 170]),
                  class: "shadow-md mb-3 w-[120px] h-[170px] object-cover" %>
          <% else %>
            <%= image_tag "no_cover.png",
                  class: "shadow-md mb-3 w-[120px] h-[170px] object-cover" %>
          <% end %>

          <% if review.image_tag.present? %>
            <span class="text-xs font-medium px-3 py-1 rounded-full shadow-sm self-start"
              style="
                background-color:<%= tag_color %>;
                color:<%= text_color %>;
                border: 2px solid <%= text_color %>;
              ">
              <%= review.image_tag.name %>
            </span>
          <% end %>
        </div>

        <!-- 右：内容 -->
        <div class="w-2/3 px-5 pt-4 pb-5 flex flex-col">

          <div class="flex flex-col gap-3">

            <!-- 投稿者 -->
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                <% if review.user.avatar.attached? %>
                  <%= image_tag review.user.avatar.variant(resize_to_fill: [36, 36]),
                        class: "w-9 h-9 rounded-full object-cover" %>
                <% else %>
                  <%= image_tag "avatar.png", class: "w-9 h-9 rounded-full object-cover" %>
                <% end %>
                <p class="text-sm font-medium text-gray-700"><%= review.user.name %></p>
              </div>

              <p class="text-sm text-gray-500 whitespace-nowrap">
                <%= review.created_at.strftime("%Y/%m/%d") %>
              </p>
            </div>

            <!-- タイトル -->
            <div class="mt-1">
              <p class="text-lg font-semibold overflow-hidden text-ellipsis whitespace-nowrap">
                <%= review.book.title %>
              </p>

              <p class="text-sm text-gray-500 overflow-hidden text-ellipsis whitespace-nowrap">
                <%= review.book.author.presence || "未設定" %>
              </p>
            </div>

            <!-- 本文 -->
            <p class="text-sm text-gray-700">

              <% preview = truncate_for_two_lines(review.content) %>

              <% if review.is_spoiler %>
                <span class="text-red-500 font-semibold">[ネタバレ]</span>

                <span class="opacity-10 hover:opacity-100 active:opacity-100 transition-opacity duration-200">
                  <%= preview %>
                </span>

              <% else %>
                <%= preview %>
              <% end %>

            </p>

          </div>

          <div class="flex justify-end mt-auto">
            <%= link_to "詳細を見る", review_path(review),
                  class: "px-4 py-2 bg-[#986321] text-white text-sm rounded-lg hover:opacity-90 transition" %>
          </div>

        </div>
      </div>

    <% end %>

  </div>
</div>
