<div class="flex justify-center items-center min-h-[87vh]">
  <div class="w-full max-w-3xl my-[1.5rem] pb-[1.5rem]">

    <h2 class="text-3xl font-bold text-center text-[#004865] mb-8">
      レビューの投稿
    </h2>

    <div class="bg-white pt-8 pb-10 px-10 rounded-xl shadow-lg space-y-8">

      <%= form_with(model: @review, local: true, html: { class: "space-y-8" }) do |f| %>

        <!-- -------------------- 上段：レビューの中心 -------------------- -->
        <div class="space-y-4 border-b border-gray-300 pb-8">
          <h3 class="text-xl font-semibold text-[#004865] mb-2">投稿する内容</h3>

          <!-- === 本の基本情報 === -->
          <%= f.fields_for :book do |b| %>

            <!-- 本のタイトル -->
            <div>
              <%= b.label :title, "本のタイトル", class: "block text-sm font-medium text-gray-700 mb-1" %>

              <% if @review.book.errors[:title].present? %>
                <p class="text-red-600 text-sm font-medium mb-1">
                  <%= @review.book.errors.full_messages_for(:title).first %>
                </p>
              <% end %>

              <%= b.text_field :title,
                    placeholder: "例：こころ",
                    class: "w-full border rounded-lg p-2 text-base focus:outline-none focus:ring-2 focus:ring-[#004865] #{ @review.book.errors[:title].present? ? 'border-red-500' : 'border-gray-300' }" %>
            </div>

            <!-- 著者名 -->
            <div>
              <%= b.label :author, "著者名", class: "block text-sm font-medium text-gray-700 mb-1" %>

              <% if @review.book.errors[:author].present? %>
                <p class="text-red-600 text-sm font-medium mb-1">
                  <%= @review.book.errors.full_messages_for(:author).first %>
                </p>
              <% end %>

              <%= b.text_field :author,
                    placeholder: "例：夏目漱石",
                    class: "w-full border rounded-lg p-2 text-base focus:outline-none focus:ring-2 focus:ring-[#004865] #{ @review.book.errors[:author].present? ? 'border-red-500' : 'border-gray-300' }" %>
            </div>

          <% end %>

          <!-- === 印象カラー === -->
          <div>
            <%= f.label :image_tag_id, "印象カラー", class: "block text-sm font-medium text-gray-700 mb-1" %>

            <p class="text-xs text-gray-500 mb-1">
              この本から受けた印象に最も合うタグを1つ選んでください。
            </p>

            <% if @review.errors[:image_tag_id].present? %>
              <p class="text-red-600 text-sm font-medium mb-1 ml-8">
                <%= @review.errors.full_messages_for(:image_tag_id).first %>
              </p>
            <% end %>

            <div class="flex items-center gap-3" data-controller="color-tag">
              <span data-color-tag-target="preview"
                    class="w-5 h-5 rounded-full border shadow-sm
                           <%= @review.errors[:image_tag_id].present? ? 'border-red-500' : 'border-gray-300' %>"></span>

              <select
                data-color-tag-target="select"
                data-action="change->color-tag#updatePreview"
                name="review[image_tag_id]"
                id="review_image_tag_id"
                class="flex-1 border rounded-lg p-2 text-base focus:outline-none focus:ring-2 focus:ring-[#004865]
                       <%= @review.errors[:image_tag_id].present? ? 'border-red-500' : 'border-gray-300' %>"
              >
                <option value="">印象カラーを選択</option>

                <% ImageTag.all.each do |tag| %>
                  <option value="<%= tag.id %>"
                          data-color="<%= tag.color %>"
                          <%= "selected" if tag.id == @review.image_tag_id %>>
                    <%= tag.name %>
                  </option>
                <% end %>
              </select>
            </div>
          </div>

          <!-- === レビュー本文 === -->
          <div>
            <div class="flex items-center gap-3 mb-1">
              <%= f.label :content, "レビュー本文", class: "block text-sm font-medium text-gray-700" %>

              <div class="flex items-center gap-1">
                <%= f.check_box :is_spoiler, class: "accent-[#004865] w-4 h-4" %>
                <%= f.label :is_spoiler, "ネタバレを含む", class: "text-sm text-gray-700 select-none" %>
              </div>
            </div>

            <% if @review.errors[:content].present? %>
              <p class="text-red-600 text-sm font-medium mb-1">
                <%= @review.errors.full_messages_for(:content).first %>
              </p>
            <% end %>

            <%= f.text_area :content, rows: 6,
                  placeholder: "読んだ感想や印象を書いてください",
                  class: "w-full border rounded-lg p-3 text-base focus:outline-none focus:ring-2 focus:ring-[#004865]
                         #{ @review.errors[:content].present? ? 'border-red-500' : 'border-gray-300' }" %>
          </div>

          <!-- === 書影アップロード（★対応形式を右隣に移動した版） === -->
          <%= f.fields_for :book do |b| %>
            <div data-controller="cover-preview" class="space-y-2">

              <!-- ラベルのすぐ右隣に対応形式 -->
              <div class="flex items-center gap-3 mb-1">
                <%= b.label :cover, "書影（画像ファイル）", class: "text-sm font-medium text-gray-700" %>
                <p class="text-xs text-gray-500">対応形式：jpg / jpeg / png（5MBまで）</p>
              </div>

              <% if @review.book.errors[:cover].present? %>
                <p class="text-red-600 text-sm font-medium mb-1">
                  <%= @review.book.errors.full_messages_for(:cover).first %>
                </p>
              <% end %>

              <%= b.file_field :cover,
                    data: { action: "change->cover-preview#show", "cover-preview-target": "input" },
                    class: "w-full border rounded-lg p-2 text-base cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#004865]
                           #{ @review.book.errors[:cover].present? ? 'border-red-500' : 'border-gray-300' }" %>

              <div class="flex items-start gap-3 mt-3">
                <img data-cover-preview-target="preview"
                     class="hidden max-h-52 rounded shadow-sm">

                <button type="button"
                        data-cover-preview-target="removeButton"
                        data-action="cover-preview#remove"
                        class="hidden -mt-1 text-gray-800 text-lg hover:text-black cursor-pointer select-none">
                  ×
                </button>
              </div>

            </div>
          <% end %>
        </div>

        <!-- -------------------- 本の詳細（任意） -------------------- -->
        <div class="space-y-4">
          <h3 class="text-xl font-semibold text-[#004865] mb-2">本の詳細（任意）</h3>

          <%= f.fields_for :book do |b| %>

            <!-- 出版社 -->
            <div>
              <%= b.label :publisher, "出版社", class: "block text-sm font-medium text-gray-700 mb-1" %>

              <% if @review.book.errors[:publisher].present? %>
                <p class="text-red-600 text-sm font-medium mb-1">
                  <%= @review.book.errors.full_messages_for(:publisher).first %>
                </p>
              <% end %>

              <%= b.text_field :publisher,
                    placeholder: "例：岩波文庫",
                    class: "w-full border rounded-lg p-2 text-base focus:outline-none focus:ring-2 focus:ring-[#004865]
                           #{ @review.book.errors[:publisher].present? ? 'border-red-500' : 'border-gray-300' }" %>
            </div>

            <!-- 発行日 -->
            <div>
              <%= b.label :published_on, "発行日", class: "block text-sm font-medium text-gray-700 mb-1" %>

              <% if @review.book.errors[:published_on].present? %>
                <p class="text-red-600 text-sm font-medium mb-1">
                  <%= @review.book.errors.full_messages_for(:published_on).first %>
                </p>
              <% end %>

              <%= b.date_field :published_on,
                    class: "w-full border rounded-lg p-2 text-base focus:outline-none focus:ring-2 focus:ring-[#004865]
                           #{ @review.book.errors[:published_on].present? ? 'border-red-500' : 'border-gray-300' }" %>
            </div>

            <!-- ISBN -->
            <div>
              <%= b.label :isbn, "ISBN", class: "block text-sm font-medium text-gray-700 mb-1" %>

              <% if @review.book.errors[:isbn].present? %>
                <p class="text-red-600 text-sm font-medium mb-1">
                  <%= @review.book.errors.full_messages_for(:isbn).first %>
                </p>
              <% end %>

              <%= b.text_field :isbn,
                    placeholder: "例：9784003101018",
                    class: "w-full border rounded-lg p-2 text-base focus:outline-none focus:ring-2 focus:ring-[#004865]
                           #{ @review.book.errors[:isbn].present? ? 'border-red-500' : 'border-gray-300' }" %>
            </div>

            <!-- あらすじ -->
            <div>
              <%= b.label :description, "あらすじ", class: "block text-sm font-medium text-gray-700 mb-1" %>

              <% if @review.book.errors[:description].present? %>
                <p class="text-red-600 text-sm font-medium mb-1">
                  <%= @review.book.errors.full_messages_for(:description).first %>
                </p>
              <% end %>

              <%= b.text_area :description, rows: 3,
                    placeholder: "作品の内容を簡単に紹介してください",
                    class: "w-full border rounded-lg p-3 text-base focus:outline-none focus:ring-2 focus:ring-[#004865]
                           #{ @review.book.errors[:description].present? ? 'border-red-500' : 'border-gray-300' }" %>
            </div>

          <% end %>
        </div>

        <!-- -------------------- 投稿ボタン -------------------- -->
        <div class="actions mt-10">
          <%= f.submit "投稿する",
                class: "w-full bg-[#986321] text-white text-lg py-3 rounded-lg hover:opacity-90 transition cursor-pointer" %>
        </div>

      <% end %>
    </div>
  </div>
</div>
