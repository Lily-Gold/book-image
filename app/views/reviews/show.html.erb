<% tag_color = @review.image_tag&.color || "#cccccc" %>
<% text_color = text_color_for(tag_color) %>

<div class="flex justify-center items-center min-h-[87vh]">
  <div class="w-full max-w-3xl my-[1.5rem] pb-[1.5rem]">

    <h2 class="text-3xl font-bold text-center text-[#004865] mb-8">
      レビュー詳細
    </h2>

    <div class="bg-white pt-8 px-10 rounded-xl shadow-lg <%= current_user == @review.user ? 'pb-8' : 'pb-1' %>">

      <!-- ▼ スマホ専用レイアウト -->
      <% avatar_url = display_image_url(@review.user, size: :avatar_48, image_attribute: :avatar) %>
      <% avatar_missing = avatar_url.blank? %>

      <div class="md:hidden mb-8 space-y-5 <%= avatar_missing ? '-mt-3' : '' %>">

        <!-- 名前 & 投稿日 -->
        <div class="flex justify-between items-center">

          <div class="flex items-center gap-2">

            <% if avatar_url.present? %>
              <%= image_tag avatar_url,
                    class: "w-9 h-9 rounded-full object-cover border border-gray-400/60 scale-[0.9]" %>
            <% else %>
              <%= image_tag "avatar.png",
                    class: "w-14 h-14 rounded-full object-cover -translate-x-2" %>
            <% end %>

            <p class="text-lg font-medium text-gray-800 <%= avatar_missing ? '-ml-5' : '' %>">
              <%= @review.user.name %>
            </p>

          </div>

          <p class="text-sm text-gray-600">
            <%= @review.created_at.strftime("%Y/%m/%d") %>
          </p>

        </div>

        <!-- いいね系 -->
        <div class="flex gap-4 <%= avatar_missing ? '-mt-2' : '' %>">
          <%= render "likes/button", review: @review %>
          <%= render "bookmarks/button", review: @review %>
          <%= render "comments/button", review: @review %>
        </div>

        <!-- 書影 + 情報 -->
        <div class="flex gap-4 items-start">

          <!-- 左カラム（書影 + 印象カラーを縦並び） -->
          <div class="flex flex-col items-start">

            <!-- 書影 -->
            <div class="w-[110px] aspect-[2/3]">

              <% cover_url =
                   if @review.book.cover.attached?
                     url_for(@review.book.cover)
                   elsif @review.book.cover_url.present?
                     @review.book.cover_url
                   end %>

              <%= image_tag(cover_url.presence || "no_cover.png",
                class: "w-full h-full object-cover rounded shadow-md") %>
            </div>

            <!-- 印象カラー（書影の下） -->
            <div class="mt-3 flex items-center gap-2">
              <p class="text-sm font-normal text-gray-600">印象カラー：</p>
              <span
                class="w-4 h-4 rounded-full border border-gray-300 shadow-sm"
                style="background-color:<%= @review.image_tag.color %>;">
              </span>
              <p class="text-sm font-medium text-gray-800">
                <%= @review.image_tag.name %>
              </p>
            </div>

          </div>

          <!-- 右カラム -->
          <div class="flex-1 space-y-3 -ml-8">

            <div>
              <p class="text-sm font-normal text-gray-600">本のタイトル</p>
              <p class="text-base font-medium text-gray-800 pl-3">
                <%= @review.book.title %>
              </p>
            </div>

            <div>
              <p class="text-sm font-normal text-gray-600">著者名</p>
              <p class="text-base font-medium text-gray-800 pl-3">
                <%= @review.book.author.presence || "未設定" %>
              </p>
            </div>

          </div>

        </div>

        <!-- 出版情報 -->
        <div class="space-y-1 text-sm text-gray-800">
          <div>
            <p class="text-gray-600">出版社</p>
            <p class="pl-3"><%= @review.book.publisher.presence || "未設定" %></p>
          </div>

          <div>
            <p class="text-gray-600">発行日</p>
            <p class="pl-3"><%= @review.book.published_on&.strftime("%Y年%m月%d日") || "未設定" %></p>
          </div>

          <div>
            <p class="text-gray-600">ISBN</p>
            <p class="pl-3"><%= @review.book.isbn.presence || "未設定" %></p>
          </div>
        </div>

      </div>

      <div class="hidden md:flex gap-8 mb-10 items-start">

        <!-- ▼ 書影 -->
        <div class="w-1/3">
          <div class="w-full aspect-[2/3] mx-auto mb-4">

            <% cover_url =
                 if @review.book.cover.attached?
                   url_for(@review.book.cover)
                 elsif @review.book.cover_url.present?
                   @review.book.cover_url
                 end
            %>

            <% if cover_url.present? %>
              <%= image_tag cover_url,
                    class: "w-full h-full object-cover rounded shadow-md" %>
            <% else %>
              <%= image_tag "no_cover.png",
                    class: "w-full h-full object-cover rounded shadow-md" %>
            <% end %>

          </div>

          <div class="flex items-center gap-3 mt-2">
            <p class="text-base font-normal text-gray-600">印象カラー：</p>
            <span class="w-5 h-5 rounded-full border border-gray-300 shadow-sm"
                  style="background-color:<%= @review.image_tag.color %>;"></span>
            <p class="text-base font-medium text-gray-800">
              <%= @review.image_tag.name %>
            </p>
          </div>
        </div>

        <!-- ▼ 本情報 -->
        <% avatar_url = display_image_url(@review.user, size: :avatar_48, image_attribute: :avatar) %>
        <% avatar_missing = avatar_url.blank? %>

        <div class="w-2/3 <%= avatar_missing ? '-mt-6' : '-mt-2' %>">

          <!-- ▼ 投稿者情報 -->
          <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">

              <% if avatar_url.present? %>
                <%= image_tag avatar_url,
                      class: "w-12 h-12 rounded-full object-cover border border-gray-400/60 scale-[0.85]" %>
              <% else %>
                <%= image_tag "avatar.png",
                      class: "w-19.5 h-19.5 rounded-full object-cover -translate-x-3.5" %>
              <% end %>

              <p class="text-lg font-medium text-gray-800 <%= avatar_missing ? '-translate-x-7.5' : '' %>">
                <%= @review.user.name %>
              </p>

            </div>

            <p class="text-sm text-gray-600">
              投稿日：<%= @review.created_at.strftime("%Y/%m/%d") %>
            </p>
          </div>

          <!-- いいね・ブックマーク行 -->
          <div
            class="
              flex items-center gap-4
              mt-1
              <%= avatar_missing ? '-translate-y-9' : '-translate-y-5' %>
            "
          >
            <%= render "likes/button", review: @review %>
            <%= render "bookmarks/button", review: @review %>
            <%= render "comments/button", review: @review %>
          </div>

          <!-- ▼ 本の詳細 -->
          <div class="space-y-1 <%= avatar_missing ? '-mt-6' : '-mt-2.5' %>">
            <p class="text-base font-normal text-gray-600">本のタイトル</p>
            <p class="text-lg font-medium text-gray-800 pl-4"><%= @review.book.title %></p>

            <p class="text-base font-normal text-gray-600">著者名</p>
            <p class="text-lg font-medium text-gray-800 pl-4"><%= @review.book.author.presence || "未設定" %></p>
          </div>

          <!-- ▼ 出版情報 -->
          <div class="space-y-2 text-gray-800 mt-7">
            <div>
              <p class="text-sm font-normal text-gray-600">出版社</p>
              <p class="text-sm font-medium text-gray-800 pl-4"><%= @review.book.publisher.presence || "未設定" %></p>
            </div>

            <div>
              <p class="text-sm font-normal text-gray-600">発行日</p>
              <p class="text-sm font-medium text-gray-800 pl-4"><%= @review.book.published_on&.strftime("%Y年%m月%d日") || "未設定" %></p>
            </div>

            <div>
              <p class="text-sm font-normal text-gray-600">ISBN</p>
              <p class="text-sm font-medium text-gray-800 pl-4"><%= @review.book.isbn.presence || "未設定" %></p>
            </div>
          </div>

        </div>
      </div>

      <!-- ▼ あらすじ・説明文 -->
      <div class="mb-10">
        <p class="text-base font-normal text-gray-600 leading-tight">あらすじ・説明文</p>
        <p class="text-base font-medium text-gray-800 leading-tight whitespace-pre-line">
          <%= @review.book.description.present? ? @review.book.description : "未設定" %>
        </p>
      </div>

      <!-- ▼ レビュー本文 -->
      <div class="mb-10">
        <div class="flex items-center gap-3 leading-tight">
          <p class="text-base font-normal text-gray-600 leading-tight">レビュー本文</p>
          <% if @review.is_spoiler %>
            <span class="text-red-500 font-semibold text-sm">[ネタバレ]</span>
          <% end %>
        </div>

        <p class="text-base font-medium text-gray-800 leading-tight whitespace-pre-line mt-0">
          <% if @review.is_spoiler %>
            <span
              data-controller="spoiler"
              data-spoiler-target="content"
              data-action="click->spoiler#toggle"
              class="opacity-10 hover:opacity-100 transition-opacity duration-200 inline-block leading-tight mt-[-20px] cursor-pointer"
            >
              <%= @review.content %>
            </span>
          <% else %>
            <%= @review.content %>
          <% end %>
        </p>
      </div>

      <!-- ▼ 編集・削除・シェア -->
      <% if current_user == @review.user %>
        <div class="flex justify-between items-center mt-6">
          <div class="flex gap-4">
            <%= link_to "編集", edit_review_path(@review),
                  class: "px-4 py-2 bg-[#986321] text-white text-sm rounded-lg hover:opacity-90 transition" %>

            <%= link_to "削除", review_path(@review),
                  data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
                  class: "px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:opacity-90 transition" %>
          </div>

          <%= link_to(
                "https://twitter.com/intent/tweet?text=#{ERB::Util.url_encode(share_text(@review))}&url=#{ERB::Util.url_encode(review_url(@review))}",
                target: "_blank", rel: "noopener noreferrer",
                class: "flex items-center gap-2 bg-black text-white px-4 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition"
             ) do %>
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                 viewBox="0 0 24 24" width="18" height="18">
              <path d="M18.244 2H21.5l-7.42 8.495L23 22h-6.828l-5.364-7.044L4.896 22H1.64l7.93-9.073L2 2h6.91l4.713 6.231L18.244 2Zm-2.42 18h1.884L7.24 4H5.27l10.554 16Z"/>
            </svg>
            <span>シェアする</span>
          <% end %>
        </div>
      <% end %>

    </div>
  </div>
</div>

<!-- ▼ コメントエリア -->
<div class="flex justify-center">
  <div class="w-full max-w-3xl mb-12">
    <div class="bg-white px-10 rounded-xl shadow-lg
            <%= user_signed_in? ? 'pt-6 pb-8' : 'pt-6 pb-2' %>">

      <!-- コメント件数 -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-[#004865]">
          コメント
          <span class="comments-count">
            <%= @review.comments.count %>
          </span>件
        </h3>
      </div>

      <!-- コメント一覧 -->
      <div id="comments-list" class="space-y-6 mb-11">
        <%= render @review.comments.includes(:user).order(created_at: :desc) %>
      </div>

      <!-- コメントフォーム -->
      <% if user_signed_in? %>
        <div id="comment-form">
          <%= render "comments/form", review: @review, comment: Comment.new %>
        </div>
      <% else %>
        <div class="text-center pt-2 pb-6 -mt-6 text-gray-500 leading-relaxed">
          コメントするにはログインが必要です

          <div class="mt-4">
            <%= link_to "ログインする",
                  new_user_session_path,
                  class: "inline-block px-4 py-2
                          bg-[#986321] text-white
                          rounded-lg text-sm
                          hover:opacity-90 transition" %>
          </div>
        </div>
      <% end %>

    </div>
  </div>
</div>

<!-- ▼ 同じ本のレビュー -->
<div class="flex justify-center mb-8">
  <div class="w-full max-w-3xl">

    <h3 class="text-xl font-semibold text-[#004865] <%= @same_book_reviews.any? ? 'mb-6' : 'mb-0' %>">
      この本の他のレビュー
    </h3>

    <% if @same_book_reviews.any? %>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <% @same_book_reviews.each do |review| %>
          <%= render "reviews/review_card_small",
                review: review,
                panel_id: "same-book" %>
        <% end %>
      </div>
    <% else %>
      <p class="text-gray-500 text-base text-center py-16 leading-relaxed">
        この本の他のレビューはまだありません
      </p>
    <% end %>

  </div>
</div>
